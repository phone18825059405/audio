;(function(window){
	var song = [
		{
			'title':'时光正好',
			'singer':'郁可唯',
			//'src':'song/Always.mp3'
			'src':'song/theRightTime.mp3',
			'lyc':'[00:01.34]时光正好\n [00:02.44]电影《夏有乔木 雅望天堂》推广曲\n [00:03.73]\n [00:04.57]作词：唐恬 \n [00:06.07]作曲：金大洲 编曲：金大洲\n [00:07.76]演唱：郁可唯\n [00:08.67]\n [00:16.46]踩碎一夜的月光\n [00:19.25]心跳像树影摇晃\n [00:23.07]我和他清白明朗\n [00:26.79]雅望一个天堂\n [00:30.68]\n [00:31.41]那是正好的时光\n [00:34.58]爱上刚好的对方\n [00:38.20]命运一声不响等我们投降\n [00:42.53]把通往幸福的方向变成各自流浪\n [00:48.16]\n [00:49.24]我爱你啊很想念很感谢有你的夏天\n [00:56.61]没有人说谎啊\n [01:00.61]可时间会擦掉承诺的话\n [01:04.17]\n [01:04.79]很爱你啊以沉默以眼泪以正好时光\n [01:12.02]我站在那年那夜那一天\n [01:18.23]你不来我不老\n [01:21.97]\n [01:46.10]单车前面的肩膀\n [01:48.46]陪我在以后流浪\n [01:52.56]可青春就是这样\n [01:56.37]流着眼泪鼓掌\n [02:00.15]\n [02:00.92]那是正好的时光\n [02:03.87]爱上刚好的对方\n [02:07.73]命运一声不响等我们投降\n [02:12.03]把通往幸福的方向变成各自流浪\n [02:17.91]\n [02:18.98]我爱你啊很想念很感谢有你的夏天\n [02:26.33]没有人说谎啊\n [02:30.07]可时间会擦掉承诺的话\n [02:33.67]\n [02:34.26]很爱你啊以沉默以眼泪以正好时光\n [02:41.70]我站在那年那夜那一天\n [02:47.76]你不来我不老\n [02:51.99]\n [03:05.12]我爱你啊很想念很感谢有你的夏天\n [03:12.29]想问你记得吗\n [03:16.01]你送我那朵没名字的花\n [03:19.19]\n [03:19.96]很爱你啊以沉默以眼泪以正好时光\n [03:27.47]我一直等在告别的那天\n [03:33.82]你不来我不老\n [03:38.37]\n'
		},
		{
			'title':'一次就好',
			'singer':'杨宗纬',
			'src':"song/onceEnough.mp3",
			'lyc':'[00:00.05]杨宗纬\n[00:01.08]一次就好\n[00:03.58]作词：陈曦\n[00:05.58]作曲：董冬冬\n[00:25.95]想看你笑\n[00:28.78]想和你闹\n [00:30.76]想拥你入我怀抱\n[00:36.38]上一秒红着脸在争吵\n [00:42.03]下一秒转身就能和好\n[00:48.38]不怕你哭\n [00:51.20]不怕你叫\n [00:53.49]因为你是我的骄傲\n[00:58.95]一双眼睛追着你乱跑\n [01:04.68]一颗心早已经准备好\n[01:16.14]一次就好\n[01:17.66]我带你去看天荒地老\n[01:21.91]在阳光灿烂的日子里\n[01:25.06]开怀大笑\n[01:27.68]在自由自在的空气里\n[01:30.78]吵吵闹闹\n[01:32.83]你可知道我唯一的想要\n[01:38.41]世界还小\n[01:40.31]我陪你去到天涯海角\n[01:44.48]在没有烦恼的角落里\n[01:47.58]停止寻找\n[01:50.31]在无忧无虑的时光里\n[01:53.36]慢慢变老\n[01:55.41]你可知道我全部的心跳\n[02:00.46]随你跳\n[02:24.39]想看你笑\n [02:27.07]想和你闹\n [02:29.45]想拥你入我怀抱\n[02:34.86]上一秒红着脸在争吵\n [02:40.68]下一秒转身就能和好\n[02:47.13]不怕你哭\n [02:50.05]不怕你叫\n [02:51.87]因为你是我的骄傲\n[02:57.57]一双眼睛追着你乱跑\n [03:03.30]一颗心早已经准备好\n[03:14.53]一次就好\n[03:16.31]我带你去看天荒地老\n[03:20.35]在阳光灿烂的日子里\n[03:23.70]开怀大笑\n[03:26.14]在自由自在的空气里\n[03:29.34]吵吵闹闹\n[03:31.40]你可知道我唯一的想要\n[03:36.92]世界还小\n[03:38.96]我陪你去到天涯海角\n[03:43.14]在没有烦恼的角落里\n[03:46.36]停止寻找\n[03:48.78]在无忧无虑的时光里\n[03:51.99]慢慢变老\n[03:56.72]你可知道我全部的心跳\n[04:04.87]随你跳'
		},
		{
			'title':'Oxygen.mp3',
			'singer':'Colbie Caillat',
			'src':'song/Oxygen.mp3',
			'lyc':'[00:00.40]Colbie Caillat-Oxygen\n[00:14.09]Album:Coco\n[00:20.61]\n[00:27.74]I came apart inside a world\n[00:31.29]made of angry people\n[00:34.42]I found a boy who had a dream\n[00:37.85]Making everyone smile\n[00:40.98]He was sunshine\n[00:44.61]I fell over my feet\n[00:49.52]Like bricks underwater\n[00:54.53]How am i supposed to\n[00:56.10]tell you how i feel\n[00:57.72]I need oxygen\n[01:01.29]Oh baby if i was your lady\n[01:06.67]I will make you happy\n[01:11.05]I\'m never gonna leave,\n [01:13.23]Never gonna leave\n [01:14.54]Oh baby I will be your lady\n [01:19.79]I am going crazy for you\n [01:26.99]\n [01:28.74]And so i found a state of mind\n [01:32.18]Where i could be speechless\n [01:35.49]I had to try it for a while\n [01:38.61]To figure out this feeling\n [01:41.96]This felt so right\n [01:45.44]Pull me upside down to a place\n [01:51.82]Where you\'ve been waiting\n[01:54.82]How am i supposed to\n[01:56.76]tell you how i feel\n[01:58.44]I need oxygen\n[02:02.11]Oh baby if i was your lady\n[02:07.48]I will make you happy\n[02:12.04]I\'m never gonna leave,\n [02:13.92]Never gonna leave\n [02:15.36]Oh baby I will be your lady\n [02:20.68]I am going crazy for you\n [02:28.69]You dont wanna keep me waiting\n [02:33.75]Staring at my fingers\n [02:37.00]feeling like a fool\n [02:40.56]\n [02:41.44]Oh baby I will be your lady\n [02:46.81]I will make you happy\n [02:51.37]I\'m never gonna leave,\n[02:53.44]Never gonna leave\n[02:54.87]Oh baby I will be your lady\n[03:00.06]I am going crazy\n[03:05.25]\n[03:15.15]Tell me what you want,\n[03:16.34]Baby tell me what you need\n[03:17.96]Anything i ask baby give it to me\n[03:21.52]\n[03:22.80]Baby give it to me,\n[03:24.18]give it to me\n[03:26.18]\n[03:28.93]I came apart inside a world\n[03:32.18]made of angry people\n[03:35.30]I found a boy who had a dream\n[03:38.68]Making everyone smile\n'
		},
		{
			'title':'夜空中最亮的星',
			'singer':'G.E.M.邓紫棋',
			'src':'song/TheFlashestStarInTheSky.mp3',
			'lyc':'[00:01.03]夜空中最亮的星\n[00:02.28]\n[00:03.37]词曲：逃跑计划\n[00:04.88]演唱：G.E.M.邓紫棋\n[00:05.92]\n[00:08.83]夜空中最亮的星 能否听清\n[00:16.10]那仰望的人 心底的孤独和叹息\n[00:25.76]夜空中最亮的星 能否记起\n[00:32.75]曾与我同行 消失在风里的身影\n[00:41.62]\n[00:42.56]我祈祷拥有一颗透明的心灵\n[00:47.06]和会流泪的眼睛\n[00:51.19]给我再去相信的勇气\n[00:55.76]越过谎言去拥抱你\n[01:00.10]每当我找不到存在的意义\n[01:04.35]每当我迷失在黑夜里\n[01:08.75]夜空中最亮的星\n[01:13.91]请照亮我前行\n[01:17.64]\n[01:22.92]夜空中最亮的星 是否知道\n[01:32.30]曾与我同行的身影 如今在哪里\n[01:37.72]夜空中最亮的星 是否在意\n[01:47.76]是太阳先升起 还是意外先来临\n[01:55.14]\n[01:57.08]我祈祷拥有一颗透明的心灵\n[02:01.51]和会流泪的眼睛\n[02:05.78]给我再去相信的勇气\n[02:10.03]越过谎言去拥抱你\n[02:13.99]每当我找不到存在的意义\n[02:18.84]每当我迷失在黑夜里\n[02:23.02]夜空中最亮的星\n[02:27.33]请照亮我前行\n[02:30.75]\n[02:33.77]夜空中最亮的星  请照亮我前行\n[02:40.48]夜空中最亮的星  请照亮我前行\n[02:49.60]夜空中最亮的星  请照亮我前行\n[02:57.92]夜空中最亮的星  请照亮我前行\n[03:05.93]\n[03:10.75]我不愿忘记你的眼睛\n[03:15.95]给我再去相信的勇气\n[03:20.08]去拥抱你\n[03:24.32]\n[03:25.59]我找不到存在的意义\n[03:28.95]我迷失在黑夜里\n[03:34.87]夜空中最亮的星 请照亮我前行\n[03:45.10]'
		},
		{
			'title':'逐梦',
			'singer':'纯音乐',
			'src':'song/runafteradream.mp3',
			'lyc':false
		},
		{
			'title':'What\'s Up',
			'singer':'4 Non Blondes',
			'src':'song/WhatsUp.mp3',
			//'lyc':'[00:30.00]25 years of my life and still\n [00:34.00]I\'m trying to get up this great big hill of hope\n [00:40.00]For a destination\n [00:44.00]I realized quickly when I knew I should\n [00:48.00]That the world was made up of this\n [00:51.00]Brotherhood of man\n [00:54.00]For whatever that means\n [00:58.00]So I cry somethimes when I\'m lying in bed\n [01:02.00]To get it all out what\'s in my head\n [01:06.00]Then I start feeling a little peculiar\n [01:13.00]So I wake in the morning and I step\n [01:16.00]Outside I take deep breath\n [01:18.00]I get real high\n [01:20.00]Then I scream from the top of my lungs\n [01:23.00]What\'s going on\n [01:27.00]And I say hey...\n [01:34.00]And I say hey what\'s goin\' on\n [01:41.00]And I say hey...\n [01:48.00]I said hey what\'s going on\n [02:24.00]And I try, oh my God do I try\n [02:30.00]I try all the time\n [02:33.00]In this institution\n [02:38.00]And I pray, oh my God do I pray\n [02:44.00]I pray every single day\n [02:48.00]For a revolution\n [02:53.00]So I cry sometimes when I\'m lying in my bed\n [02:56.00]To get it all out what\'s in my head\n [03:00.00]Then I start feeling a little peculiar\n [03:07.00]So I wake in the morning and I step outside\n [03:10.00]I take a deep breaththen I get real high\n [03:14.00]Then I scream from the top of my lungs\n [03:17.00]What\'s goin\' on\n [03:20.00]And I say hey...\n [03:28.00]And I say hey what\'s going\' on\n [03:34.00]And I say hey...\n [03:42.00]I said hey what\'s goin\' on\n [03:48.00]And I say hey...\n [03:56.00]And I say hey what\'s goin\' on\n [04:02.00]And I say hey...\n [04:10.00]I said hey what\'s goin\' on\n [04:32.00]25 years of my life and still\n [04:37.00]I\'m trying to get up that great big hill of hope\n [04:43.00]For a destination\n'
			'lyc':false,
		},
		{
			'title':'Young And Beautiful',
			'singer':'Lana Del Rey',
			'src':'song/YoungAndBeautiful.mp3',
			'lyc':'[00:00.68]Young And Beautiful\n [00:01.60]Lana Del Rey\n [00:02.38]\n [00:16.20]I\'ve seen the world\n [00:18.17]Done it all, had my cake now\n [00:24.28]Diamonds, brilliant, and Bel-Air now\n [00:32.09]Hot summer nights, mid-July\n [00:36.61]When you and I were forever wild\n [00:40.60]The crazy days, the city lights\n [00:44.57]The way you\'d play with me like a child\n [00:49.07]\n [00:50.20]Will you still love me when I\'m no longer young and beautiful\n [00:58.39]Will you still love me when I got nothing but my aching soul\n [01:05.43]I know you will, I know you will\n [01:09.37]I know that you will\n [01:13.26]Will you still love me when I\'m no longer beautiful\n [01:20.57]\n [01:22.15]I\'ve seen the world, lit it up as my stage now\n [01:30.22]Channeling angels in the new age now\n [01:38.09]Hot summer days, rock and roll\n [01:42.55]The way you\'d play for me at your show\n [01:46.78]And all the ways I got to know\n [01:50.70]Your pretty face and electric soul\n [01:55.00]\n [01:56.42]Will you still love me when I\'m no longer young and beautiful\n [02:04.59]Will you still love me when I got nothing but my aching soul\n [02:12.43]I know you will, I know you will\n [02:16.40]I know that you will\n [02:20.35]Will you still love me when I\'m no longer beautiful\n [02:27.56]\n [02:29.77]Dear lord when I get to heaven\n [02:33.78]Please let me bring my man\n [02:37.88]When he comes tell me that you\'ll let me\n [02:42.00]Father tell me if you can\n [02:45.44]\n [02:45.80]Oh that grace, oh that body\n [02:49.74]Oh that face makes me wanna party\n [02:54.01]He\'s my sun, he makes me shine like diamonds\n [03:01.39]\n [03:03.23]Will you still love me when I\'m no longer young and beautiful\n [03:11.44]Will you still love me when I got nothiyg but my aching soul\n [03:18.60]I know you will, I know you will\n [03:22.66]I know that you will\n [03:26.73]Will you still love me when I\'m no longer beautiful\n [03:35.16]Will you still love me when I\'m no longer beautiful\n [03:44.01]Will you still love me when I\'m no longer young and beautiful\n [03:51.05]\n'
		},
		{
			'title':'Everything',
			'singer':'太阳的眼泪',
			'src':'song/Everytime.mp3',
			'lyc':false
		},
		{
			'title':'Everything',
			'singer':'太阳的眼泪',
			'src':'song/Everytime.mp3',
			'lyc':false
		},
		{
			'title':'YouAreMyEverything',
			'singer':'太阳的眼泪',
			//'src':'song/YouAreMyEverything.mp3',
			'src':'http://ws.stream.qqmusic.qq.com/C200004Obe3Z1ov6Cf.m4a?vkey=366841E53E3303509B45A8F7F570409C45DB7F3A7485722596E32880A4E56114D6C43AB7EEC7B1A05F7B2D88EA097A0C4BA644E64092FBB2&guid=9077984344&fromtag=30',
			'lyc':'[00:15.13]처음부터 그대였죠.\n[00:22.38]나에게 다가올 한 사람.\n[00:29.82]단 한 번의 스침에도 내 눈빛이 말을 하죠.\n[00:43.14]바람처럼 스쳐가는\n[00:50.37]인연이 아니길 바래요.\n[00:57.48]바보처럼 먼저 말하지 못했죠.\n[01:06.65]할 수가 없었죠.\n[01:13.40]You Are My Everything\n[01:18.05]별처럼 쏟아지는 운명에\n[01:24.44]그대라는 사람을 만나고\n[01:29.62]멈춰버린 내 가슴속에\n[01:36.55]단 하나의 사랑\n[01:41.50]You Are My Everything\n[01:50.72]안갯속에 피어나는\n[01:57.61]하얗게 물들은 그대 모습\n[02:04.76]한순간에 내게 심장이 멈출 듯 다가와 버렸죠.\n[02:20.25]You Are My Everything\n[02:25.13]별처럼 쏟아지는 운명에\n[02:31.82]그대라는 사람을 만나고\n[02:36.69]멈춰버린 내 가슴속에\n[02:43.63]단 하나의 사랑\n[02:48.59]You Are My Everything\n[02:54.24]시작도 못 했던 나의 사랑을\n[03:00.01]이제는 말할 수 있죠\n[03:03.51]누구도 가질 수 없는 기적인데\n[03:10.56]You Are My Everything\n[03:14.44]뜨거운 내 사랑은 그댄 걸\n[03:21.48]계절이 변해도 난 이곳에\n[03:26.00]멈춰버린 내 가슴속에\n[03:32.97]단 하나의 사랑\n[03:38.07]You Are My Everything\n[03:48.42]'

		}
	];

	function addClass(el, className) {
		if (!className) return;
		if (el.classList) {
			el.classList.add(className);
		} else {
			el.className += ' ' + className;
		}
	};

	function removeClass(el, className) {
		if (!className) return;
		if (el.classList) {
			el.classList.remove(className);
		} else {
			el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
		}
	};

	function hasClass(el, className) {
		if (!className) return false;
		if (el.classList) {
			return el.classList.contains(className);
		} else {
			return new RegExp('(^| )' + className + '( |$)', 'gi').test(el.className);
		}
	};
	function findtargetParent(ele){
		var arr = [];
		while(ele = ele.parentNode){if(ele.nodeType==1 && ele.nodeName.toLowerCase() == 'dd'){arr.push(ele)}};
			return arr;
	}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	var player = document.querySelector('#player');
	var startCount;
	var sIndex = 0;//当前播放歌曲索引
	var lrcColumn;
	var lyricsGlobal;
	var parsed = {}; //歌词对象
	var index_temp;//防止timeUpdate事件多次触发
	var mode = 0;

	function _audio(options){
		this.audioEle     = player || options.audioEle;//音频节点
		this._bottom      = document.querySelector('.bottom') || options._bottom;//主功能区
		this.scrollBar    = document.querySelector('#progress') || options.scrollBar;//滚动条
		this.scrollPoint  = document.querySelector('.point') || options.scrollPoint;//滚动小圆点
		this.bar_t        = document.querySelector('.bar-t') || options.bar_t;//上层滚动样式条
		this.bar_b        = document.querySelector('.bar-b') || options.bar_b;//下层滚动样式条
		this.controlBar   = document.querySelector('.line-3') || options.controlBar;//播放控制组
		this.songList     = document.querySelector('.dl-wrapper') || options.songList;//播放列表
		this.modeEle      = document.querySelector('#mode') || options.modeEle;//播放顺序切换的文档节点
		this.lyrics       = document.querySelector('#lyrics') || options.lyrics;//歌词节点
		this.flicker      = false;
		this._bottomH     = this._bottom.offsetHeight;

		var that = this;

		this.renderList(song);//加载播放列表
		this.resizeLyc();//rem调整
		this.scrollBarHandler(this.scrollBar);//滑动改变播放时间
		this.listEventHandler(this.songList);//播放列事件

		//播放控制按钮组事件监听
		this.controlBar.addEventListener('touchstart',function(e){
			e = e || window.e;
			if(e.target.nodeName.toLowerCase() == 'i'){
				that.ControlBartStart(e.target);
			}

			switch(e.target.id)
			{
				case 'mode':
				console.log('mode')
				break;
				case 'prev':
				console.log('prev')
				break;
				case 'play':
				console.log('start')
				break;
				case 'next':
				console.log('next')
				break;
				case 'list':
				console.log('list')
				break;
			}
		},false)

		this.controlBar.addEventListener('touchend',function(e){
			e = e || window.e;
			if(e.target.nodeName.toLowerCase() == 'i'){
				that.ControlBartEnd(e.target);
			}
			
			switch(e.target.id)
			{
				case 'mode':
				that.changeMode();
				break;
				case 'prev':
					that.prevSong();
				break;
				case 'play':
				//播放暂停图标切换
					if(player.paused){		
						//e.target.innerHTML = '&#xe61c;';
						that.audioEle.play();					
					}
					else{
						//e.target.innerHTML = '&#xe61e;';
						that.audioEle.pause();
					}
				break;
				case 'next':
					that.nextSong();
				break;
				case 'list':
				//显示播放列表
						document.querySelector('#queue').style.display = 'block';
						document.querySelector('.mask').style.display = 'block';
						setTimeout(function(){
							document.querySelector('#queue').style.opacity = 1;
							document.querySelector('.mask').style.opacity = 1;
						},10)
				break;
			}

		},false)

		//播放列表关闭
		document.querySelector('#shut').addEventListener('touchstart',that.shut,false)
		document.querySelector('.mask').addEventListener('touchstart',that.shut,false)

		//更新歌词和播放时间等
		this.audioEle.addEventListener("timeupdate",function(){

			var audioEle = that.audioEle;//音频节点
			var scrollBar = that.scrollBar;//滚动条
			var scrollPoint = that.scrollPoint;//滚动小圆点
			var bar_t = that.bar_t;//上层滚动样式条

			var len = player.buffered.length;
			if(len > 0 && len != undefined){
				document.querySelector('.bar-b').style.width = (player.buffered.end(len - 1) / player.duration)*100 +'%';
			}

			scrollPoint.style.left = bar_t.style.width = parseInt(audioEle.currentTime) * (scrollBar.offsetWidth / audioEle.duration) + 'px';
			//scrollPoint.style.left = bar_t.style.width = (audioEle.played.end(0) / audioEle.duration)*100 + '%';

			var second = '00',minute = '00';
			var currentTime = parseInt(player.currentTime);

			var minute = parseInt(currentTime/60);
				minute = minute>9?minute:'0'+minute;
			var second = currentTime%60;
				second = second>9?second:'0'+second;
			
			document.querySelectorAll('.timer')[0].innerText = minute+':'+second;


			
			that.updateLyric();
		},false);

		//歌曲播放完之后根据播放模式继续播放
		this.audioEle.addEventListener('ended',function(){

			switch(mode)
			{
				case 0:
					that.nextSong();
				break;
				case 1:
					that.randomMode();
					that.startPlay();
				break;

				case 2:
					sIndex = sIndex;
					that.startPlay();
				break;
			}
		})
		//歌曲下载时更新缓冲数据段
		this.audioEle.addEventListener('progress',function(){
			/*var len = player.buffered.length;
			if(len > 0 && len != undefined){
				document.querySelector('.bar-b').style.width = (player.buffered.end(len - 1) / player.duration)*100 +'%';
			}*/
			
		})

		//播放时
		this.audioEle.addEventListener('pause',function(){
			document.querySelector('#play').innerHTML = '&#xe61e;';
		})

		//暂停时
		this.audioEle.addEventListener('playing',function(){
			document.querySelector('#play').innerHTML = '&#xe61c;';
		})

		this.audioEle.addEventListener('emptied',function(){console.log('网络连接关闭')})
		this.audioEle.addEventListener('empty',function(){console.log('发生错误阻止下载')})
		this.audioEle.addEventListener('canplay',function(){

			var totalTime = parseInt(player.duration);

			var minute = parseInt(totalTime/60);
				minute = minute>9?minute:'0'+minute;
			var second = totalTime%60;
				second = second>9?second:'0'+second;
			
			document.querySelectorAll('.timer')[1].innerText = minute+':'+second;
		})
		this.audioEle.addEventListener('canplay',function(){document.querySelector('.line-1 span').style.visibility='hidden'})
		this.audioEle.addEventListener('waiting',function(){document.querySelector('.line-1 span').style.visibility='visible'})

		document.querySelector('.amount .order').addEventListener('touchend',function(){
			that.changeMode();
		})
	}

	_audio.prototype.renderList = function(song){
		var fg = document.createDocumentFragment();
		for(var i=0,len=song.length; i<len; i++){
			var dd = document.createElement('dd');
			dd.className = 'list';
			dd.innerHTML = '<span class="name">'+ song[i]['title'] +'</span><span class="singer"> -'+ song[i]['singer'] +'</span><div class="Icon_pause"><span></span><span></span><span></span><span></span></div><i id="del" class=" iconfont">&#xe620;</i>'
			fg.appendChild(dd);
		}
		this.songList.appendChild(fg);
		//console.log(111);
	}
	_audio.prototype.scrollBarHandler = function(targetEle){

		var that = this;
		var startX, moveX = 0, endX, currentX = 0, tempX = 0;//分别为touchstart触点,touchmove滑动距离，touchend触点，

		var EventHandler = {
			tStart:function(e){

				startX = e.touches[0].pageX;
				tempX = moveX;

				that.scrollBar.addEventListener('touchmove',EventHandler.tMove,false);
				that.scrollBar.addEventListener('touchend',EventHandler.tEnd,false);
				//console.log(startX);
			},
			tMove:function(e){

				moveX = e.changedTouches[0].pageX - startX;

				that.audioEle.currentTime = ((currentX + moveX) / that.scrollBar.offsetWidth) * that.audioEle.duration;
				that.scrollPoint.style.left = that.bar_t.style.width = ((currentX + moveX) / that.scrollBar.offsetWidth)*100 + '%';

				if(parseFloat(that.scrollPoint.style.left) < 0){
					that.audioEle.currentTime = 0;
					that.scrollPoint.style.left = that.bar_t.style.width = 0;
					currentX = 0;
					that.scrollBar.removeEventListener('touchend',EventHandler.tEnd);

				}else if(parseFloat(that.scrollPoint.style.left) > that.scrollBar.offsetWidth){
					that.audioEle.currentTime = that.audioEle.duration;
					that.scrollPoint.style.left = that.bar_t.style.width = '100%';
					currentX = parseFloat(document.defaultView.getComputedStyle(that.scrollPoint, null).left);
					that.scrollBar.removeEventListener('touchend',EventHandler.tEnd);
				}	
			},
			tEnd:function(e){

				endX = e.changedTouches[0].pageX;

				if(Math.abs(tempX - moveX) < 5){
					that.audioEle.currentTime = ((endX - that.scrollBar.offsetLeft) / that.scrollBar.offsetWidth) * that.audioEle.duration;
					that.scrollPoint.style.left = that.bar_t.style.width = ((endX - that.scrollBar.offsetLeft) / that.scrollBar.offsetWidth)*100 + '%';
				}

				currentX = parseFloat(document.defaultView.getComputedStyle(that.scrollPoint, null).left);
				console.log(currentX);

				//startCount = setInterval(function(){that.count()},1000);
			}				
		}

		targetEle.addEventListener('touchstart',EventHandler.tStart,false);	
	}
	_audio.prototype.listEventHandler = function(targetEle){
		var that = this;
		var startTx=0,startTy=0,endTx=0,endTy=0;

		var EventHandler = {
			tStart:function( e ){
		  				var touches = e.touches[0];
		  				startTx = touches.clientX;
		  				startTy = touches.clientY;
		  				//console.log('tStart' + startTy);
		  				targetEle.addEventListener('touchend',EventHandler.tEnd,false);
					},
			tEnd: function( e ){
		  				var touches = e.changedTouches[0];
		    			endTx = touches.clientX;
		    			endTy = touches.clientY;
		    			//console.log(endTy+'|||');
		  // 在部分设备上 touch 事件比较灵敏，导致按下和松开手指时的事件坐标会出现一点点变化
		  				if( Math.abs(startTx - endTx) < 6 && Math.abs(startTy - endTy) < 6 ){
		   			 		console.log( 'fire tap event' );
		   			 		e.stopPropagation();
		   			 		document.querySelector('#lyrics ul').innerHTML = '';
							console.log(e.target);
							if(e.target.nodeName.toLowerCase() == 'span' || e.target.nodeName.toLowerCase() == 'dd'){
								//console.log(e.target)
								var lists = document.querySelectorAll('.dl-wrapper .list');								
								if( e.target.nodeName.toLowerCase() == 'dd'){
									var index = Array.prototype.indexOf.call(lists,e.target);
								}else{
									var index = Array.prototype.indexOf.call(lists,findtargetParent(e.target)[0]);
								}
								
								sIndex = index;
								console.log(index);
								player.src = song[index]['src'];

								that.startPlay();
								that.shut();
							}else if(e.target.id == 'del'){
								/*var index = Array.prototype.indexOf.call(list.targetEle,e.target.parentNode);
								console.log(index)
								document.querySelector('.dl-wrapper').removeChild(document.querySelectorAll('.list')[index]);
								song.splice(index,1);
								document.querySelector('.amount span').innerHTML = '播放队列('+ song.length +')'*/
							}

		  				}
		  				}
					}		
		
		targetEle.addEventListener('touchstart',EventHandler.tStart,false);	
	}
	//播放
	_audio.prototype.startPlay = function(custom){
		lyricsGlobal = {};
		parsed = {};		
		this.bar_b.style.width = this.scrollPoint.style.left = this.bar_t.style.width = 0;
		document.querySelector('#lyrics ul').style.transition = "none"
		document.querySelector('#lyrics ul').style.transform = "none"
		setTimeout(function(){document.querySelector('#lyrics ul').style.transition = ""},17)


		var that =  this;

		if(!custom){
			var index = sIndex;
			player.src = song[index]['src'];
		}
		
		//歌词
		this.lyrics.querySelector('ul').innerHTML = '';//清空歌词
		this.lyrics.querySelector('ul').style.transform = '';

		if(song[index]['lyc'] == false){
			lyricsGlobal = undefined;
			console.log('无歌词')
			this.lyrics.querySelector('ul').innerHTML = '此歌曲暂无歌词';						
		}else{
			lyricsGlobal = this.parseLyric(song[index]['lyc'])//歌词
		}

		player.play();

		//激活当前播放样式
		if(document.querySelector('.currentsong')){
			document.querySelector('.currentsong').classList.remove('currentsong');
		}

		if(document.querySelector('.Icon_playing')){
			document.querySelector('.Icon_playing').className = 'Icon_pause';
		}
		document.querySelectorAll('.list div')[index].className = 'Icon_playing';
		document.querySelector('.dl-wrapper').children[index].classList.add('currentsong');

		this.renderLyric(lyricsGlobal);
	}
	//读取歌词
	_audio.prototype.parseLyric = function(lrc) {
	    var lyrics = lrc.split("\n");
	    var lrcObj = {};
	    for(var i=0;i<lyrics.length;i++){

	        var lyric = decodeURIComponent(lyrics[i]);

	        var timeReg = /\[\d*:\d*((\.|\:)\d*)*\]/g;
	        var timeRegExpArr = lyric.match(timeReg);
	        //console.log(timeRegExpArr);
	        if(!timeRegExpArr)continue;
	        var clause = lyric.replace(timeReg,'');

	        for(var k = 0,h = timeRegExpArr.length;k < h;k++) {
	            var t = timeRegExpArr[k];
	            var min = Number(String(t.match(/\[\d*/i)).slice(1)),
	                sec = Number(String(t.match(/\:[\d.]*/i)[0].slice(1)));
	            var time = min * 60 + sec;
	            lrcObj[time] = clause;
	        }
	    }
	    return lrcObj;
	}
	//窗口resize时适配歌词高度
	_audio.prototype.resizeLyc = function(){
		var that = this;
		//document.querySelectorAll('.timer')[1].innerHTML = document.documentElement.offsetWidth;
		/*var ratio = (window.innerWidth*0.625) / 320;
			ratio = ratio>=12?parseInt(ratio):12;*/
		//调整rem基值
		//document.querySelector('html').style.fontSize = ratio +'px';
		var ratio = window.getComputedStyle(document.querySelector('html')).fontSize.match(/\d+/)[0]*1
		//渲染歌词列表
		//var PfontSize = parseInt(ratio*16);
		var wh = window.innerHeight;
		//console.log(this._bottomH);
		var bottomHeight = document.querySelector('.bottom').offsetHeight;
		var column = parseInt((wh - bottomHeight - (ratio*4)) / (ratio*3));
			column = column%2!==0?column:column-1;
			lrcColumn = column;
		 document.querySelector('#lyrics').style.height = column *3 + 'rem';
		 document.querySelector('#lyrics').style.paddingTop = (column-1)/2 *3 + 'rem';
		 
		 window.addEventListener('resize',function(){
		 	that.audioEle.pause();
		 	that.resizeLyc();
		 },false)
		//document.querySelector('#show_setting').addEventListener('click',this.renderLyc,false)
	}
	//渲染歌词
	_audio.prototype.renderLyric = function (data){
		var frg = document.createDocumentFragment();
		var i = 0;
	    for(var k in data){
	        var txt = data[k];
	        if(!txt)continue;
	        parsed[k] = {
	            index:i,
	            text:txt,
	            top: i*3
	        };     
	        var li = document.createElement('li');
	        li.setAttribute('data-column',i);
	        li.innerHTML = txt;
	        frg.appendChild(li);
	        i++;
	        //console.log()
	    }
	    this.lyrics.querySelector('ul').appendChild(frg);
	    //player.addEventListener("timeupdate",this.updateLyric,false);
	}
	//更新歌词
	_audio.prototype.updateLyric = function(){
		if(player.paused || lyricsGlobal ==undefined)return;
	    var data = parsed;
	    if(!data)return;
	    var currentTime = player.currentTime;
	    //console.log(currentTime)
	    var lrc;
	    for(t in data){
	    	if(currentTime >= t){
	    		lrc = data[t];
	    	}
	    	//console.log(typeof(t));
	    }
	    //console.log(lrc);
	    if(!lrc || lrc.index == index_temp)return;
	    //console.log(lrc);
	    var text = lrc.text;

	    index_temp = lrc.index;
	    //console.log(text);
	    if(text.length != 0){
	        locationLrc(lrc);     
	    }
	    function locationLrc(lrc){
	    	var lrcEle = document.querySelector('#lyrics ul');
	    	if(lrcEle.querySelector('.on')){
	    		lrcEle.querySelector('.on').className = '';
	    	}

	    	/*if(lrcEle.querySelector('.fadeout')){
	    		var fadeouts = document.querySelectorAll('.fadeout');
	    		for(var z=0;z<fadeouts.length;z++){
	    			removeClass(fadeouts[z],'fadeout');
	    		}
	    	}*/
	    	//console.log(lrc);
	    	lrcEle.children[lrc.index].className = 'on';


	    	/*var getIndex = lrcEle.querySelector('.on').getAttribute('data-column');*/
				/*if(lrcEle.children[lrc.index-(lrcColumn-1)/2]){
	    			addClass(lrcEle.children[lrc.index-(lrcColumn-1)/2],'fadeout');
	    		}
	    		if(lrcEle.children[lrc.index+(lrcColumn-1)/2]){
	    			addClass(lrcEle.children[lrc.index+(lrcColumn-1)/2],'fadeout');
	    		}*/

	    	lrcEle.style.webkitTransform = 'translateY('+(-lrc.top)+'rem)';
	    }
	}
	//操作按钮组的触控效果
	_audio.prototype.ControlBartStart = function(ele){
		ele.style.opacity = .7;
	}
	_audio.prototype.ControlBartEnd = function(ele){
		ele.style.webkitTransition = 'opacity 500ms ease';
		ele.style.opacity = '';
		setTimeout(function(){
			ele.style.webkitTransition = '';
		},500)
	}
	//上一首歌曲
	_audio.prototype.nextSong = function(){//下一首歌曲
		sIndex ++;
		if(sIndex > song.length-1){
			sIndex = 0;
		}
		this.startPlay();
	}
	//下一首歌曲
	_audio.prototype.prevSong = function(){//上一首歌曲
		sIndex --;
		if(sIndex < 0){
			sIndex = song.length-1;
		}
		this.startPlay();
	}
	//切换播放模式
	_audio.prototype.changeMode = function(){//切换播放模式
		//var to;
		function showMsg(str){
			showMsg.to = 0;
			clearTimeout(showMsg.to)
			if(!str)return;
			var msg = document.querySelector('.msg');
			msg.textContent = str;
			msg.style.display='block';
			showMsg.to = setTimeout(function(){
				msg.style.opacity=1;
				setTimeout(function(){
					msg.style.opacity = 0;
					msg.style.display = 'none';
				},2000)
			},17)
		}

		mode++;
		if(mode > 2){
			mode = 0;
		}
		switch(mode)
		{
			case 0:
				document.querySelector('.amount .order').innerHTML = '&#xe60d;';
				this.modeEle.innerHTML = '&#xe60d;';
				showMsg('顺序播放')
			break;

			case 1:
				document.querySelector('.amount .order').innerHTML = '&#xe612;';
				this.modeEle.innerHTML = '&#xe612;';
				showMsg('随机播放')
			break;

			case 2:
				document.querySelector('.amount .order').innerHTML = '&#xe618;';
				this.modeEle.innerHTML = '&#xe618;';
				showMsg('单曲循环')
			break;
		}
		//console.log(mode)
	
	}	
	//随机播放模式	
	_audio.prototype.randomMode = function(){
		sIndex = parseInt(Math.random() * song.length-1)
	}
	_audio.prototype.shut = function(){
		document.querySelector('#queue').style.opacity = 0;
		document.querySelector('.mask').style.opacity = 0;	
		setTimeout(function(){
			document.querySelector('#queue').style.display='none';
			document.querySelector('.mask').style.display='none';
		},300)
	}	
new _audio();
})(window)